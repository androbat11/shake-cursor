# X11 (X Window System, Version 11)

## Definition

**X11** is a display server protocol created in 1984 at MIT. It defines how graphical applications communicate with the display server to create windows, draw graphics, and receive input.

The **X server** (typically **Xorg**) is the program that implements the X11 protocol. It is the display server running on your machine.

```
X11   = The protocol (the language/contract)
Xorg  = The display server (the program that speaks X11)
```

## X11 Architecture

X11 follows a **client-server model** where the naming is counterintuitive:

| Term | What it is | Why the name feels backwards |
|------|-----------|-------------------------------|
| **X Server** | The display server (Xorg) running on your machine | It **serves** display and input resources |
| **X Client** | The application (Firefox, Terminal) | It **consumes** display and input resources |

The server is the one with the hardware. The clients are the ones that want to use it.

```
┌─────────────────────────────────────────────────────────────────────┐
│                          Your Machine                               │
│                                                                     │
│   X CLIENTS (applications)              X SERVER (Xorg)             │
│                                                                     │
│   ┌─────────────┐                  ┌───────────────────────────┐    │
│   │  Firefox    │──── X11 ────────►│                           │    │
│   └─────────────┘    protocol      │         Xorg              │    │
│                                    │                           │    │
│   ┌─────────────┐                  │  • Owns the screen        │    │
│   │  Terminal   │──── X11 ────────►│  • Owns the input devices │    │
│   └─────────────┘    protocol      │  • Draws pixels           │    │
│                                    │  • Routes events          │    │
│   ┌─────────────┐                  │                           │    │
│   │  File Mgr   │──── X11 ────────►│                           │    │
│   └─────────────┘    protocol      └──────────┬────────────────┘    │
│                                               │                    │
│                                               ▼                    │
│                                    ┌───────────────────────┐        │
│                                    │      Hardware         │        │
│                                    │  GPU, Monitor, Mouse  │        │
│                                    │  Keyboard             │        │
│                                    └───────────────────────┘        │
└─────────────────────────────────────────────────────────────────────┘
```

## What the X Server Does

### 1. Manages the Display

The X server has **exclusive control** over the display hardware:

```
┌─────────────────────────────────────────────────────────────┐
│                    Display Management                       │
│                                                             │
│   X Server manages:                                         │
│                                                             │
│   ┌──────────────────┐                                      │
│   │  Root Window      │  ← The desktop background           │
│   │  ┌────────────┐  │                                      │
│   │  │  Window A   │  │  ← Application windows              │
│   │  │  ┌───────┐  │  │                                      │
│   │  │  │ Child │  │  │  ← Nested windows (dialogs, etc.)   │
│   │  │  └───────┘  │  │                                      │
│   │  └────────────┘  │                                      │
│   │  ┌────────────┐  │                                      │
│   │  │  Window B   │  │                                      │
│   │  └────────────┘  │                                      │
│   └──────────────────┘                                      │
│                                                             │
│   Everything on screen is a window in a tree hierarchy.     │
│   The root window is the trunk. App windows are branches.   │
└─────────────────────────────────────────────────────────────┘
```

**Window Hierarchy:**
```
Root Window (desktop)
├── Firefox Window
│   ├── Tab Bar (child window)
│   ├── URL Bar (child window)
│   └── Content Area (child window)
├── Terminal Window
└── File Manager Window
    └── Dialog (child window)
```

### 2. Handles All Input

The X server is the **single point of entry** for all user input:

```
┌────────────────────────────────────────────────────────────────────┐
│                       Input Handling                               │
│                                                                    │
│   ┌─────────┐    ┌─────────┐                                       │
│   │  Mouse  │    │Keyboard │                                       │
│   └────┬────┘    └────┬────┘                                       │
│        │              │                                            │
│        └──────┬───────┘                                            │
│               ▼                                                    │
│   ┌───────────────────────┐                                        │
│   │       X Server        │                                        │
│   │                       │                                        │
│   │  1. Receives raw      │                                        │
│   │     hardware event    │                                        │
│   │                       │                                        │
│   │  2. Converts to       │                                        │
│   │     X11 event         │                                        │
│   │                       │                                        │
│   │  3. Determines which  │                                        │
│   │     window should     │                                        │
│   │     receive it        │                                        │
│   │                       │                                        │
│   │  4. Delivers event    │                                        │
│   │     to that window's  │                                        │
│   │     client            │                                        │
│   └───────────┬───────────┘                                        │
│               │                                                    │
│       ┌───────┴────────┐                                           │
│       ▼                ▼                                           │
│   ┌────────┐     ┌──────────┐                                      │
│   │Firefox │     │ Terminal │                                      │
│   │(cursor │     │(receives │                                      │
│   │ is over│     │ keyboard │                                      │
│   │ it)    │     │ focus)   │                                      │
│   └────────┘     └──────────┘                                      │
│                                                                    │
│   Mouse events → go to window under cursor                         │
│   Keyboard events → go to window with focus                        │
└────────────────────────────────────────────────────────────────────┘
```

### 3. Maintains Global State

The X server knows **everything** about the desktop. Any client can ask:

```
┌─────────────────────────────────────────────────────────────┐
│                    Global State                             │
│                                                             │
│   The X server tracks:                                      │
│                                                             │
│   Cursor                                                    │
│   ├── Global position (x: 540, y: 320)                      │
│   ├── Current shape (arrow, hand, text beam)                │
│   └── Which window it's over                                │
│                                                             │
│   Windows                                                   │
│   ├── All window positions and sizes                        │
│   ├── Window hierarchy (parent-child)                       │
│   ├── Z-order (stacking)                                    │
│   ├── Visibility state                                      │
│   └── Properties (title, class, type)                       │
│                                                             │
│   Keyboard                                                  │
│   ├── Which window has focus                                │
│   ├── Current layout (US, ES, etc.)                         │
│   ├── Modifier state (Shift, Ctrl, Alt)                     │
│   └── Key mapping table                                     │
│                                                             │
│   Screens                                                   │
│   ├── Resolution                                            │
│   ├── Color depth                                           │
│   └── Monitor arrangement                                   │
│                                                             │
│   IMPORTANT: Any X client can query ALL of this state.      │
│   This is powerful but also a security weakness.            │
└─────────────────────────────────────────────────────────────┘
```

### 4. Network Transparency

A unique feature of X11 — applications can run on a different machine than the display:

```
┌─────────────────────┐           Network           ┌─────────────────────┐
│   Remote Machine    │                              │   Your Machine      │
│                     │                              │                     │
│  ┌───────────────┐  │         X11 Protocol         │  ┌───────────────┐  │
│  │  Application  │  │ ────────────────────────────►│  │   X Server    │  │
│  │  (X Client)   │  │          (TCP/SSH)           │  │   (Xorg)      │  │
│  └───────────────┘  │                              │  └───────┬───────┘  │
│                     │                              │          │          │
│  App runs HERE      │                              │          ▼          │
│                     │                              │  ┌───────────────┐  │
│                     │                              │  │   Monitor     │  │
│                     │                              │  └───────────────┘  │
│                     │                              │                     │
│                     │                              │  Display is HERE    │
└─────────────────────┘                              └─────────────────────┘
```

This is why the naming feels backwards:
- The **server** is where the screen is (it serves pixels and input)
- The **client** is where the application runs (it requests display resources)

## X11 Communication In Practice

### Connecting to the X Server

Every X client must first connect:

```
┌────────┐                                         ┌────────┐
│ Client │                                         │X Server│
└───┬────┘                                         └───┬────┘
    │                                                  │
    │ ── Connect via /tmp/.X11-unix/X0 ──────────────► │
    │                                                  │
    │ ◄── Connection accepted ─────────────────────── │
    │     Server info:                                │
    │     • Protocol version: 11.0                     │
    │     • Screen count: 1                            │
    │     • Screen size: 1920x1080                     │
    │     • Root window ID: 0x1a2                      │
    │     • Available extensions                       │
    │                                                  │
```

The **DISPLAY** environment variable tells clients where to connect:
```
DISPLAY=:0          → Local X server, display 0
                      Socket: /tmp/.X11-unix/X0
```

### Creating and Showing a Window

```
┌────────┐                                         ┌────────┐
│ Client │                                         │X Server│
└───┬────┘                                         └───┬────┘
    │                                                  │
    │ ── CreateWindow(parent=root, x=100, y=100, ────► │
    │                  w=800, h=600)                    │
    │                                                  │
    │ ◄── Window created, ID=0x2c00001 ─────────────── │
    │                                                  │
    │ ── MapWindow(0x2c00001) ────────────────────────► │
    │    "make it visible"                             │
    │                                                  │
    │ ◄── Expose event ──────────────────────────────── │
    │    "window is visible, you need to draw it"      │
    │                                                  │
    │ ── Drawing commands (PutImage, FillRectangle) ──► │
    │                                                  │
```

### Receiving Input Events

```
┌────────┐                                         ┌────────┐
│ Client │                                         │X Server│
└───┬────┘                                         └───┬────┘
    │                                                  │
    │    (user moves mouse over client's window)       │
    │                                                  │
    │ ◄── MotionNotify(x=150, y=230, time=48291) ──── │
    │                                                  │
    │ ◄── MotionNotify(x=152, y=228, time=48301) ──── │
    │                                                  │
    │    (user clicks)                                 │
    │                                                  │
    │ ◄── ButtonPress(button=1, x=152, y=228) ──────── │
    │                                                  │
    │ ◄── ButtonRelease(button=1, x=152, y=228) ────── │
    │                                                  │
    │    (user types)                                  │
    │                                                  │
    │ ◄── KeyPress(keycode=38, state=0) ────────────── │
    │     (keycode 38 = 'a')                           │
    │                                                  │
```

### Querying Cursor Position (Key for shake-cursor)

```
┌────────┐                                         ┌────────┐
│ Client │                                         │X Server│
└───┬────┘                                         └───┬────┘
    │                                                  │
    │ ── QueryPointer(root_window) ───────────────────► │
    │                                                  │
    │ ◄── Reply: ──────────────────────────────────── │
    │     root_x: 540                                  │
    │     root_y: 320                                  │
    │     child_window: 0x2c00001                      │
    │     win_x: 440   (relative to child window)      │
    │     win_y: 220                                   │
    │     mask: Button1 pressed                        │
    │                                                  │
    │    ANY client can make this request at ANY time   │
    │    No permissions needed. No window required.     │
    │                                                  │
```

This is why X11 is ideal for shake-cursor:
- We can query cursor position **globally**
- We don't need our own window
- We don't need special permissions
- We can poll as fast as we want

## X11 Security Model (or Lack Thereof)

X11 was designed in an era of trusted networks. **Every client is fully trusted:**

```
┌─────────────────────────────────────────────────────────────┐
│             What ANY X11 client can do:                      │
│                                                             │
│   ✅ Query global cursor position                            │
│   ✅ Read keyboard input meant for other windows             │
│   ✅ Take screenshots of any window                          │
│   ✅ Inject fake input events (keystrokes, clicks)           │
│   ✅ Move, resize, or close other windows                    │
│   ✅ Read clipboard contents                                 │
│   ✅ Register global hotkeys                                 │
│                                                             │
│   This is great for tools like shake-cursor.                │
│   This is terrible for security.                            │
│                                                             │
│   This is the #1 reason Wayland was created:                │
│   to isolate applications from each other.                  │
└─────────────────────────────────────────────────────────────┘
```

## X11 Extensions Relevant to shake-cursor

| Extension | Purpose | Relevance |
|-----------|---------|-----------|
| **XInput2** | Advanced input (multi-pointer, raw events) | Get raw mouse motion events without polling |
| **XFIXES** | Cursor utilities | Track cursor changes |
| **XTest** | Inject fake input | Could simulate actions on shake detection |

### XInput2: Event-Driven Alternative to Polling

Instead of repeatedly calling `QueryPointer`, we can **subscribe to mouse motion events**:

```
┌────────────────────────────────────────────────────────────────────┐
│                                                                    │
│   Polling Approach:                    Event-Driven Approach:      │
│                                                                    │
│   loop {                               Subscribe to root window    │
│     pos = QueryPointer()               motion events, then:       │
│     analyze(pos)                                                   │
│     sleep(10ms)                        on MotionNotify(x, y) {    │
│   }                                      analyze(x, y)            │
│                                        }                           │
│                                                                    │
│   ⚠ Wastes CPU asking                  ✅ Only runs when mouse     │
│     even when mouse                      actually moves            │
│     isn't moving                                                   │
│                                                                    │
│   ⚠ Can miss fast                      ✅ Gets every single        │
│     movements between                    motion event              │
│     polls                                                          │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

## Xorg: The X Server Implementation

**Xorg** (X.Org Server) is the standard implementation of the X11 protocol:

| Aspect | Detail |
|--------|--------|
| **Full name** | X.Org Server |
| **Implements** | X11 protocol (version 11, revision 6+) |
| **Socket** | `/tmp/.X11-unix/X0` |
| **Config** | `/etc/X11/xorg.conf` or `/etc/X11/xorg.conf.d/` |
| **Log** | `/var/log/Xorg.0.log` |
| **Process** | Runs as `Xorg` or `X` |

### Verify Xorg is Running (on your Fedora XFCE)

```bash
# Check if Xorg is running
ps aux | grep Xorg

# Check your DISPLAY variable
echo $DISPLAY       # Should output :0 or :1

# List connected clients
xlsclients

# Get X server info
xdpyinfo | head -20
```

## Summary

| Concept | Definition |
|---------|------------|
| **X11** | The protocol specification |
| **X Server (Xorg)** | The program implementing X11, controls hardware |
| **X Client** | Any application using X11 to display windows |
| **Root Window** | The desktop, parent of all windows |
| **DISPLAY** | Environment variable pointing to the X server |

For **shake-cursor**, X11 gives us:
1. **`QueryPointer`** — Poll cursor position anytime
2. **`MotionNotify` events** — Get notified on every mouse movement
3. **No permissions needed** — Any client can access global cursor state
4. **Low latency** — Direct Unix socket communication with the server
